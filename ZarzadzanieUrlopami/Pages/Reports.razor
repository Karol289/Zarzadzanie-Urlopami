@page "/reports"
@using ZarzadzanieUrlopami.Models
@using ZarzadzanieUrlopami.Service
@using System.Globalization

@inject ReportsService reportsService

<div class="report-page">
    <h3>Raport nieobecności pracowników</h3>

    <div class="report-container">
        <div class="month-selector">
            <div class="calendar-container">
                <div class="month">
                    <ul>
                        <li class="prev" @onclick="PreviousMonth">&#10094;</li>
                        <li class="next" @onclick="NextMonth">&#10095;</li>
                        <li>@CurrentMonthName <br><span class="year">@CurrentYear</span></li>
                    </ul>
                </div>
                <button class="report-button" @onclick="LoadReport">Pokaż raport</button>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Ładowanie...</span>
            </div>
        }
        else if (pracownicy != null && pracownicy.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Pracownik</th>
                            <th>Urlopy</th>
                            <th>Zwolnienia lekarskie</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var pracownik in pracownicy)
                        {
                            <tr>
                                <td>@pracownik.Imie @pracownik.Nazwisko</td>
                                <td>
                                    @if (pracownik.Urlopies.Any())
                                    {
                                        <ul class="absence-list">
                                            @foreach (var urlop in pracownik.Urlopies)
                                            {
                                                <li>
                                                    <strong>@urlop.IdTypuUrlopuNavigation?.Nazwa</strong>
                                                    <br />
                                                    @FormatDateRange(urlop.DataPocz, urlop.DataKon)
                                                    <br />
                                                    <span class="badge @GetStatusClass(urlop.IdStatusu)">
                                                        @urlop.IdStatusuNavigation?.Wyjaśnienie
                                                    </span>
                                                </li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <span>Brak urlopów w tym miesiącu</span>
                                    }
                                </td>
                                <td>
                                    @if (pracownik.ZwolnieniaLekarskies.Any())
                                    {
                                        <ul class="absence-list">
                                            @foreach (var zwolnienie in pracownik.ZwolnieniaLekarskies)
                                            {
                                                <li>
                                                    <strong>@zwolnienie.IdTypuNavigation?.Nazwa</strong>
                                                    <br />
                                                    @FormatDateRange(zwolnienie.DataPocz, zwolnienie.DataKon)
                                                    @if (!string.IsNullOrEmpty(zwolnienie.Opis))
                                                    {
                                                        <br />
                                                        <small>@zwolnienie.Opis</small>
                                                    }
                                                </li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <span>Brak zwolnień lekarskich w tym miesiącu</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else if (!isLoading && showReport)
        {
            <div class="alert alert-info">
                Brak danych o nieobecnościach dla wybranego miesiąca.
            </div>
        }
    </div>
</div>

@code {
    private List<Pracownicy> pracownicy;
    private int CurrentMonth = DateTime.Now.Month;
    private int CurrentYear = DateTime.Now.Year;
    private bool isLoading = false;
    private bool showReport = false;

    private string CurrentMonthName => new DateTime(CurrentYear, CurrentMonth, 1)
        .ToString("MMMM", CultureInfo.GetCultureInfo("pl-PL"));

    private void PreviousMonth()
    {
        CurrentMonth--;
        if (CurrentMonth < 1)
        {
            CurrentMonth = 12;
            CurrentYear--;
        }
    }

    private void NextMonth()
    {
        CurrentMonth++;
        if (CurrentMonth > 12)
        {
            CurrentMonth = 1;
            CurrentYear++;
        }
    }

    private async Task LoadReport()
    {
        isLoading = true;
        showReport = true;
        pracownicy = await reportsService.GetPracownicyWithAbsencesInMonth(CurrentMonth, CurrentYear);
        isLoading = false;
        StateHasChanged();
    }

    private string FormatDateRange(DateOnly? start, DateOnly? end)
    {
        if (!start.HasValue && !end.HasValue)
            return "Brak danych";

        if (start.HasValue && !end.HasValue)
            return $"Od {start.Value.ToString("dd.MM.yyyy")}";

        if (!start.HasValue && end.HasValue)
            return $"Do {end.Value.ToString("dd.MM.yyyy")}";

        return $"{start.Value.ToString("dd.MM.yyyy")} - {end.Value.ToString("dd.MM.yyyy")}";
    }

    private string GetStatusClass(int statusId)
    {
        return statusId switch
        {
            1 => "bg-success", // zatwierdzony (approved)
            2 => "bg-success", // zatwierdzony (approved)
            3 => "bg-danger",  // odrzucony (rejected)
            _ => "bg-warning"  // Assume oczekujący (pending) for others
        };
    }
}

<style>
    .report-page {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
    }

    .report-page h3 {
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .report-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 20px 0;
        width: 100%;
        overflow-x: hidden;
    }

    .month-selector {
        margin-bottom: 20px;
        width: 100%;
        max-width: 350px;
    }

    .calendar-container {
        width: 100%;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }

    .month {
        padding: 15px;
        background: #0275d8;
        text-align: center;
        border-radius: 8px 8px 0 0;
    }

    .month ul {
        margin: 0;
        padding: 0;
        list-style-type: none;
    }

    .month ul li {
        color: white;
        font-size: 18px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .month .year {
        font-size: 16px;
    }

    .month .prev, .month .next {
        cursor: pointer;
        padding: 8px 12px;
        font-size: 16px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .month .prev:hover, .month .next:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .month .prev {
        float: left;
    }

    .month .next {
        float: right;
    }

    /* Enhanced report button styling */
    .report-button {
        padding: 12px 16px;
        font-size: 16px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.3s;
        background: #0275d8;
        color: white;
        border: none;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(2, 117, 216, 0.2);
        margin: 15px auto;
        display: block;
        width: 90%;
    }

    .report-button:hover {
        background: #025aa5;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(2, 117, 216, 0.3);
    }

    .report-button:active {
        transform: translateY(0);
    }

    .absence-list {
        padding-left: 15px;
        margin-bottom: 0;
    }

    .absence-list li {
        margin-bottom: 10px;
        padding: 8px;
        border-left: 3px solid #0275d8;
        background-color: rgba(2, 117, 216, 0.05);
        border-radius: 0 4px 4px 0;
    }

    .table-responsive {
        width: 100%;
        overflow-x: auto;
    }

    /* For mobile devices */
    @@media (max-width: 768px) {
        .month ul li {
            font-size: 14px;
        }
        
        .month .year {
            font-size: 12px;
        }
        
        .report-button {
            padding: 10px 14px;
            font-size: 14px;
        }
        
        .absence-list li {
            padding: 5px;
        }
    }
</style>
